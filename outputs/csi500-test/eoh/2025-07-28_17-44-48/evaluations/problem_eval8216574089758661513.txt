import numpy as np
import pandas as pd

def heuristics_v2(df):
    def compute_factor(row_idx):
        ema = df['close'].iloc[max(0, row_idx-5):row_idx+1].ewm(span=5, adjust=False).mean().iloc[-1]
        max_high = df['high'].iloc[max(0, row_idx-10):row_idx+1].max()
        min_volume_30 = df['volume'].iloc[max(0, row_idx-30):row_idx+1].min()
        return (ema / max_high) - np.log(row['volume'] / min_volume_30)
    
    heuristics_matrix = df.reset_index().apply(lambda row: compute_factor(row.name), axis=1)
    return heuristics_matrix
