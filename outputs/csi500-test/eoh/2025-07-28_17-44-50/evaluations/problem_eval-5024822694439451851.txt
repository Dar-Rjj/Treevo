def heuristics_v2(df):
    df['ema_50'] = df['close'].ewm(span=50, adjust=False).mean()
    df['distance_to_ema'] = abs(df['close'] - df['ema_50'])
    df['up_days_volume'] = (df['volume'][df['close'].pct_change() > 0]).rolling(window=60).sum()
    df['down_days_volume'] = (df['volume'][df['close'].pct_change() < 0]).rolling(window=60).sum()
    df['volume_ratio_up_down_vol_std_adjusted'] = df['up_days_volume'] / (df['down_days_volume'] + 1e-8) / df['volume'].rolling(window=60).std()
    df['price_variance'] = (df['high'] - df['low']).rolling(window=30).var()
    df['composite_factor'] = (df['distance_to_ema'] * 0.4 +
                              df['volume_ratio_up_down_vol_std_adjusted'] * 0.3 +
                              df['price_variance'] * 0.3)
    heuristics_matrix = df['composite_factor'].copy()
    return heuristics_matrix
