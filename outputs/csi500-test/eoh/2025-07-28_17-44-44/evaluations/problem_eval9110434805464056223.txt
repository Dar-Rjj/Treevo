import pandas as pd
import numpy as np

def heuristics_v2(df):
    # Rate of change in closing prices over 21 days
    roc_close = df['close'].pct_change(periods=21)
    
    # Logarithm of the ratio between the highest and lowest volume in the last 40 days
    vol_ratio_log = np.log(df['volume'].rolling(window=40).max() / df['volume'].rolling(window=40).min())
    
    # Average True Range (ATR) over 15 days
    tr = pd.Series(np.maximum((df['high'] - df['low']), np.maximum(abs(df['high'] - df['close'].shift()), abs(df['low'] - df['close'].shift()))), name='tr')
    atr = tr.rolling(window=15).mean()
    
    # ATR-adjusted momentum: difference between high and low adjusted by ATR
    atr_adj_momentum = (df['high'] - df['low']) / atr
    
    # Composite alpha factor
    heuristics_matrix = roc_close + vol_ratio_log + atr_adj_momentum
    
    return heuristics_matrix
