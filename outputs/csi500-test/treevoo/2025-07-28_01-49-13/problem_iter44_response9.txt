```python
import pandas as pd

def heuristics_v2(df):
    # Calculate daily return
    df['daily_return'] = df['close'].pct_change()
    
    # Difference between close and open price
    df['close_open_diff'] = df['close'] - df['open']
    
    # Percentage change from open to close
    df['open_close_pct_change'] = df['close_open_diff'] / df['open']
    
    # Average volume over 5 days
    df['avg_volume_5d'] = df['volume'].rolling(window=5).mean()
    
    # Ratio of current day's volume to average volume
    df['volume_ratio'] = df['volume'] / df['avg_volume_5d']
    
    # Number of up and down days in a window (5 days)
    df['up_day'] = (df['close'] > df['open']).astype(int)
    df['down_day'] = (df['close'] < df['open']).astype(int)
    df['up_days_5d'] = df['up_day'].rolling(window=5).sum()
    df['down_days_5d'] = df['down_day'].rolling(window=5).sum()
    
    # Ratio of up days to total days in the window
    df['up_days_ratio'] = df['up_days_5d'] / 5
    
    # Range of the day (high - low)
    df['range'] = df['high'] - df['low']
    
    # Ratio of the range to the close price
    df['range_to_close_ratio'] = df['range'] / df['close']
    
    # Average amount traded over 5 days
    df['avg_amount_5d'] = df['amount'].rolling(window=5).mean()
    
    # Ratio of current day's amount to the average amount
    df['amount_ratio'] = df['amount'] / df['avg_amount_5d']
    
    # 7-day and 21-day simple moving averages of close prices
    df['sma_7d'] = df['close'].rolling(window=7).mean()
    df['sma_21d'] = df['close'].rolling(window=21).mean()
    
    # Compare the current close price with the 7-day SMA
    df['close_above_sma_7d'] = (df['close'] > df['sma_7d']).astype(int)
    
    # Determine if the 7-day SMA is rising or falling compared to the 21-day SMA
    df['sma_7d_rising'] = (df['sma_7d'] > df['sma_21d']).astype(int)
    
    # Percentage change in volume from the previous day
    df['volume_pct_change'] = df['volume'].pct_change()
    
    # Percentage change in close price from the previous day
    df['close_pct_change'] = df['close'].pct_change()
    
    # Calculate the difference between the current day's open price and the previous day's close price
    df['price_gap'] = df['open'] - df['close'].shift(1)
    
    # Categorize the gap as up, down, or no gap
    df['gap_up'] = (df['price_gap'] > 0.02 * df['close'].shift(1)).astype(int)
    df['gap_down'] = (df['price_gap'] < -0.02 * df['close'].shift(1)).astype(int)
    
    # Exponential moving average (EMA) of close prices
    df['ema_14d'] = df['close'].ewm(span=14, adjust=False).mean()
    
    # Difference between EMA and 7-day SMA
    df['ema_sma_diff'] = df['ema_14d'] - df['sma_7d']
    
    # High-low spread
    df['high_low_spread'] = df['high'] - df['low']
    
    # Open-close price change
    df['open_close_change'] = df['close'] - df['open']
    
    # Composite factor by averaging the factors
    composite_factor = (
        df['open_close_pct_change'] +
        df['volume_ratio'] +
        df['up_days_ratio'] +
        df['range_to_close_ratio'] +
        df['amount_ratio'] +
        df['close_above_sma_7d'] +
        df['sma_7d_rising'] +
        df['volume_pct_change'] +
        df['close_pct_change'] +
        df['gap_up'] - df['gap_down'] +
        df['ema_sma_diff'] +
        df['high_low_spread'] +
        df['open_close_change']
    ) / 13
    
   
