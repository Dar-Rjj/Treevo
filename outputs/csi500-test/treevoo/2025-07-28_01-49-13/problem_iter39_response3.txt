```python
import pandas as pd

def heuristics_v2(df):
    # Calculate the 7-day and 21-day simple moving averages of close prices
    df['SMA_7'] = df['close'].rolling(window=7).mean()
    df['SMA_21'] = df['close'].rolling(window=21).mean()
    
    # Determine if the close price is above or below the 7-day SMA
    df['Close_Above_SMA_7'] = (df['close'] > df['SMA_7']).astype(int)
    
    # Determine if the 7-day SMA is rising or falling compared to the 21-day SMA
    df['SMA_7_Rising'] = (df['SMA_7'] > df['SMA_21']).astype(int)
    
    # Calculate the percentage change in volume and close price from the previous day
    df['Volume_Change'] = df['volume'].pct_change()
    df['Close_Change'] = df['close'].pct_change()
    
    # Determine if high volume accompanies significant price changes
    df['High_Volume_Price_Change'] = ((df['Volume_Change'] > 0.2) & ((df['Close_Change'] > 0.05) | (df['Close_Change'] < -0.05))).astype(int)
    
    # Detect gaps between consecutive days' prices
    df['Gap'] = df['open'].shift(-1) - df['close']
    df['Up_Gap'] = (df['Gap'] > 0.05 * df['close']).astype(int)
    df['Down_Gap'] = (df['Gap'] < -0.05 * df['close']).astype(int)
    
    # Calculate the range (high - low) for the current day
    df['Range'] = df['high'] - df['low']
    
    # Calculate the average range over the past 7 days
    df['Avg_Range_7'] = df['Range'].rolling(window=7).mean()
    
    # Compare the current day's range with the average range
    df['Increased_Volatility'] = (df['Range'] > 1.5 * df['Avg_Range_7']).astype(int)
    df['Decreased_Volatility'] = (df['Range'] < 0.5 * df['Avg_Range_7']).astype(int)
    
    # Calculate the difference between the close price and the open price
    df['Close_Open_Diff'] = df['close'] - df['open']
    
    # Categorize the day as up, down, or flat
    df['Day_Up'] = (df['Close_Open_Diff'] > 0).astype(int)
    df['Day_Down'] = (df['Close_Open_Diff'] < 0).astype(int)
    df['Day_Flat'] = (df['Close_Open_Diff'] == 0).astype(int)
    
    # Calculate the number of consecutive up or down days
    df['Consecutive_Up'] = (df['Day_Up'].groupby((df['Day_Up'] != df['Day_Up'].shift()).cumsum()).cumcount() + 1) * df['Day_Up']
    df['Consecutive_Down'] = (df['Day_Down'].groupby((df['Day_Down'] != df['Day_Down'].shift()).cumsum()).cumcount() + 1) * df['Day_Down']
    
    # Determine if the market is trending or consolidating
    df['Trending_Market'] = (df['Consecutive_Up'] > 3) | (df['Consecutive_Down'] > 3)
    
    # Combine all the sub-thoughts into a single factor
    df['Factor'] = (
        df['Close_Above_SMA_7'] +
        df['SMA_7_Rising'] +
        df['High_Volume_Price_Change'] +
        df['Up_Gap'] -
        df['Down_Gap'] +
        df['Increased_Volatility'] -
        df['Decreased_Volatility'] +
        df['Day_Up'] -
        df['Day_Down'] +
        df['Trending_Market']
    )
    
    return df['Factor']
```
