def heuristics_v2(df):
    def wma(series, n=21, weights=None):
        if weights is None:
            weights = list(range(1, n + 1))
        return series.rolling(window=n).apply(lambda x: (x * weights[-len(x):]).sum() / sum(weights), raw=True)
    
    def cmf_smoothed(df, n=21):
        money_flow_multiplier = ((df['close'] - df['low']) - (df['high'] - df['close'])) / (df['high'] - df['low'])
        money_flow_volume = money_flow_multiplier * df['volume']
        cmf_ema = money_flow_volume.ewm(span=n, adjust=False).mean()
        return cmf_ema
    
    close_wma = wma(df['close'].pct_change(), n=21)
    cmf_line = cmf_smoothed(df, n=21)
    heuristics_matrix = (close_wma + cmf_line) / 2
    return heuristics_matrix
