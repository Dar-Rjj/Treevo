import pandas as pd

def heuristics_v2(df):
    # Calculate daily return, volume change, and ATR
    df['daily_return'] = df['close'].pct_change()
    df['volume_change'] = df['volume'].pct_change()
    high_low = df['high'] - df['low']
    high_close = abs(df['high'] - df['close'].shift())
    low_close = abs(df['low'] - df['close'].shift())
    ranges = pd.concat([high_low, high_close, low_close], axis=1)
    df['true_range'] = ranges.max(axis=1)
    df['atr'] = df['true_range'].rolling(window=14).mean()
    
    # Assign weights based on the magnitude of daily return, volume change, and ATR
    df['price_weight'] = (df['daily_return'].abs() / df['daily_return'].abs().rolling(window=30).mean()).fillna(0)
    df['volume_weight'] = (df['volume_change'].abs() / df['volume_change'].abs().rolling(window=30).mean()).fillna(0)
    df['atr_weight'] = (df['atr'] / df['atr'].rolling(window=30).mean()).fillna(0)
    
    # Calculate the weighted sum of features
    df['weighted_sum'] = (df['open'] * df['price_weight'] + 
                          df['high'] * df['volume_weight'] +
                          df['low'] * df['atr_weight'] + 
                          df['close'] * (1 - df['price_weight']) +
                          df['volume'] * (1 - df['volume_weight']))
    
    # Create the heuristics matrix
    heuristics_matrix = df['weighted_sum']
    
    return heuristics_matrix
