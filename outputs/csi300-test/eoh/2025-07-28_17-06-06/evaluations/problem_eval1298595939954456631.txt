import pandas as pd
import numpy as np

def heuristics_v2(df):
    def compute_RSI(data, window=14):
        delta = data.diff(1)
        up, down = delta.copy(), delta.copy()
        up[up < 0] = 0
        down[down > 0] = 0
        roll_up = up.ewm(com=window-1, adjust=False).mean()
        roll_down = down.abs().ewm(com=window-1, adjust=False).mean()
        RS = roll_up / roll_down
        return 100 - (100 / (1 + RS))
    
    def compute_stochastic(data, k_period=14, d_period=3):
        L14 = data.rolling(window=k_period, min_periods=k_period).min()
        H14 = data.rolling(window=k_period, min_periods=k_period).max()
        k_percent = 100 * ((data - L14) / (H14 - L14))
        d_percent = k_percent.rolling(window=d_period, min_periods=d_period).mean()
        return k_percent, d_percent
    
    close_prices = df['close']
    rsi = compute_RSI(close_prices)
    stoch_k, stoch_d = compute_stochastic(close_prices)
    ma_short = df['close'].rolling(window=5, min_periods=5).mean()
    ma_long = df['close'].rolling(window=20, min_periods=20).mean()

    heuristics_matrix = (rsi + stoch_d + (ma_short > ma_long).astype(int)).fillna(0)
    return heuristics_matrix
