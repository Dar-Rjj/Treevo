```python
import pandas as pd
import numpy as np

def heuristics_v2(df):
    # Momentum and Trend Analysis
    df['close_ema_10'] = df['close'].ewm(span=10, adjust=False).mean()
    df['roc_5_adjusted'] = (df['close'].pct_change(periods=5) * df['volume']) / df['volume'].rolling(window=5).mean()
    
    # Volume Anomaly and Surge Detection
    df['volume_ma_21'] = df['volume'].rolling(window=21).mean()
    df['vol_anomaly_flag'] = np.where((df['volume'] > 1.5 * df['volume_ma_21']) | (df['volume'] < 0.5 * df['volume_ma_21']), 1, 0)
    df['max_volume_30'] = df['volume'].rolling(window=30).max()
    df['volume_ratio_30'] = df['volume'] / df['max_volume_30']
    
    # Price Volatility and Stability
    df['close_std_7'] = df['close'].rolling(window=7).std()
    df['atr_14'] = df[['high', 'low', 'close']].rolling(window=14).apply(lambda x: np.max(x) - np.min(x), raw=True)
    df['atr_ratio_7'] = df['atr_14'] / df['atr_14'].shift(7)
    
    # Reversal and Continuation Patterns
    def engulfing_pattern(row, prev_row):
        if (row['open'] < row['close']) and (prev_row['open'] > prev_row['close']):
            return (row['close'] > prev_row['open']) and (row['open'] < prev_row['close'])
        elif (row['open'] > row['close']) and (prev_row['open'] < prev_row['close']):
            return (row['close'] < prev_row['open']) and (row['open'] > prev_row['close'])
        return False
    
    df['engulfing_pattern'] = [engulfing_pattern(row, df.shift(1).iloc[i]) for i, row in df.iterrows()]
    df['gap_next_day'] = (df['open'].shift(-1) - df['close']).abs() > 0.01 * df['close']
    df['confirmed_engulfing'] = df['engulfing_pattern'] & df['gap_next_day']
    
    def hammer_hanging_man(row):
        lower_shadow = min(row['close'], row['open']) - row['low']
        upper_shadow = row['high'] - max(row['close'], row['open'])
        body = abs(row['close'] - row['open'])
        if (lower_shadow >= 2 * body) and (upper_shadow <= 0.5 * lower_shadow):
            return True
        return False
    
    df['hammer_hanging_man'] = df.apply(hammer_hanging_man, axis=1)
    df['next_day_close_higher'] = df['close'].shift(-1) > df['close']
    df['pattern_follow_up'] = df['hammer_hanging_man'] & (df['next_day_close_higher'] != df['hammer_hanging_man'])
    
    # Liquidity and Trading Activity
    df['volume_to_amount_ratio'] = df['volume'] / df['amount']
    df['vta_ratio_ma_14'] = df['volume_to_amount_ratio'].rolling(window=14).mean()
    df['vta_ratio_diff'] = (df['volume_to_amount_ratio'] - df['vta_ratio_ma_14']) / df['vta_ratio_ma_14']
    
    df['up_volume'] = df.apply(lambda x: x['volume'] if x['close'] > x['open'] else 0, axis=1)
    df['down_volume'] = df.apply(lambda x: x['volume'] if x['close'] < x['open'] else 0, axis=1)
    df['ud_ratio'] = df['up_volume'].rolling(window=14).sum() / df['down_volume'].rolling(window=14).sum()
    df['ud_ratio_ma_14'] = df['ud_ratio'].rolling(window=14).mean()
    df['ud_ratio_diff'] = (df['ud_ratio'] - df['ud_ratio_ma_14']) / df['ud_ratio_ma_14']
    
    # Final Alpha Factor
    df['alpha_factor'] = (
        df['roc_5_adjusted'] + 
        df['volume_ratio_30'] + 
        df['atr_ratio_7'] + 
        df['confirmed_engulfing'].astype(int) + 
       
