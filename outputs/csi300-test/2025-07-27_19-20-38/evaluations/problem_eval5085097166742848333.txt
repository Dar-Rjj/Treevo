import pandas as pd
import numpy as np

def heuristics_v2(df):
    # Calculate RSI
    delta = df['close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
    rs = gain / loss
    rsi = 100 - (100 / (1 + rs))
    
    # Calculate ADX
    tr = pd.concat([df['high'] - df['low'], 
                    (df['high'] - df['close'].shift()).abs(), 
                    (df['low'] - df['close'].shift()).abs()], axis=1).max(axis=1)
    atr = tr.rolling(window=14).mean()
    plus_dm = (df['high'].diff().clip(lower=0)).fillna(0)
    minus_dm = (-df['low'].diff().clip(upper=0)).fillna(0)
    plus_di = 100 * (plus_dm.rolling(window=14).mean() / atr)
    minus_di = 100 * (minus_dm.rolling(window=14).mean() / atr)
    dx = 100 * (np.abs(plus_di - minus_di) / (plus_di + minus_di))
    adx = dx.rolling(window=14).mean()
    
    # Calculate A/D Line
    money_flow_multiplier = ((df['close'] - df['low']) - (df['high'] - df['close'])) / (df['high'] - df['low'])
    money_flow_volume = money_flow_multiplier * df['volume']
    ad_line = money_flow_volume.cumsum()
    
    # Combine factors
    heuristics_matrix = 0.5 * rsi + 0.3 * adx + 0.2 * (ad_line / ad_line.mean())
    
    return heuristics_matrix
