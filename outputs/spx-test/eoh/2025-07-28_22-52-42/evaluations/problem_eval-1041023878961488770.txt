import pandas as pd
import numpy as np

def heuristics_v2(df):
    # Calculate the natural logarithm of the low prices and volume
    df['log_low'] = np.log(df['low'])
    df['log_volume'] = np.log(df['volume'])

    # Calculate the 30-day Simple Moving Average (SMA) for log_low
    df['SMA_30_log_low'] = df['log_low'].rolling(window=30).mean()

    # Calculate the 30-day Exponentially Weighted Moving Average (EWMA) for log_volume
    df['EWMA_30_log_volume'] = df['log_volume'].ewm(span=30, adjust=False).mean()

    # Calculate the 10-day Coefficient of Variation (CV) for close prices
    df['std_close_10'] = df['close'].rolling(window=10).std()
    df['mean_close_10'] = df['close'].rolling(window=10).mean()
    df['CV_close_10'] = df['std_close_10'] / df['mean_close_10']

    # Create the heuristic: difference between EWMA_30_log_volume and SMA_30_log_low, scaled by CV_close_10
    heuristics_matrix = (df['EWMA_30_log_volume'] - df['SMA_30_log_low']) * df['CV_close_10']

    return heuristics_matrix
