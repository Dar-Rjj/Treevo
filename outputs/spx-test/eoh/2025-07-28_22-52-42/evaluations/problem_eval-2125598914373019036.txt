import pandas as pd
import numpy as np

def heuristics_v2(df):
    # Calculate the price change for RSI calculation
    df['price_change'] = df['close'].diff()
    
    # Calculate gain/loss
    df['gain'] = df['price_change'].apply(lambda x: max(x, 0))
    df['loss'] = -df['price_change'].apply(lambda x: min(x, 0))
    
    # Calculate the 14-period smoothed gains and losses
    df['avg_gain'] = df['gain'].rolling(window=14).mean()
    df['avg_loss'] = df['loss'].rolling(window=14).mean()
    
    # Calculate RS and RSI
    df['RS'] = df['avg_gain'] / df['avg_loss']
    df['RSI_14'] = 100 - (100 / (1 + df['RS']))
    
    # Calculate the 5-day EMA of RSI and the 20-day SMA of RSI
    df['EMA_5_RSI'] = df['RSI_14'].ewm(span=5, adjust=False).mean()
    df['SMA_20_RSI'] = df['RSI_14'].rolling(window=20).mean()
    
    # Create the heuristic: difference between EMA_5_RSI and SMA_20_RSI
    heuristics_matrix = df['EMA_5_RSI'] - df['SMA_20_RSI']
    
    return heuristics_matrix
