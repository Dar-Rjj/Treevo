import pandas as pd
import numpy as np

def heuristics_v2(df):
    # Compute daily return
    df['daily_return'] = df['close'].pct_change()
    
    # Calculate Rate of Change (ROC)
    df['roc'] = df['close'].pct_change(periods=10)
    
    # Calculate RSI
    delta = df['close'].diff(1)
    gain = delta.where(delta > 0, 0)
    loss = -delta.where(delta < 0, 0)
    avg_gain = gain.rolling(window=14).mean()
    avg_loss = loss.rolling(window=14).mean()
    rs = avg_gain / avg_loss
    df['rsi'] = 100 - (100 / (1 + rs))
    
    # Calculate Aroon Oscillator
    aroon_up = 100 * df['high'].rolling(window=25).apply(lambda x: (x.argmax() + 1) / 25, raw=True)
    aroon_down = 100 * df['low'].rolling(window=25).apply(lambda x: (x.argmin() + 1) / 25, raw=True)
    df['aroon_oscillator'] = aroon_up - aroon_down
    
    # Rolling 60-day historical MAE
    mae_roc = (df['roc'] - df['daily_return'].shift(-1)).abs().rolling(window=60).mean()
    mae_rsi = (df['rsi'] - df['daily_return'].shift(-1)).abs().rolling(window=60).mean()
    mae_aroon = (df['aroon_oscillator'] - df['daily_return'].shift(-1)).abs().rolling(window=60).mean()
    
    # Normalize MAE to get weights
    total_mae = mae_roc + mae_rsi + mae_aroon
    weight_roc = 1 - (mae_roc / total_mae)
    weight_rsi = 1 - (mae_rsi / total_mae)
    weight_aroon = 1 - (mae_aroon / total_mae)
    
    # Generate heuristic matrix
    heuristics_matrix = (df['roc'] * weight_roc +
                         df['rsi'] * weight_rsi +
                         df['aroon_oscillator'] * weight_aroon)
    
    return heuristics_matrix
