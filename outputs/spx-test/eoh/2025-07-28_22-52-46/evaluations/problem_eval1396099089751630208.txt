import pandas as pd
import ta

def heuristics_v2(df):
    # Compute daily return
    df['daily_return'] = df['close'].pct_change()
    
    # Calculate RSI
    df['rsi'] = ta.momentum.RSIIndicator(close=df['close'], window=14).rsi()
    
    # Calculate ATR
    df['atr'] = ta.volatility.AverageTrueRange(high=df['high'], low=df['low'], close=df['close'], window=14).average_true_range()
    
    # Calculate MACD
    macd = ta.trend.MACD(close=df['close'], window_slow=26, window_fast=12, window_sign=9)
    df['macd'] = macd.macd()
    df['macd_signal'] = macd.macd_signal()
    df['macd_diff'] = macd.macd_diff()
    
    # Rolling historical return correlations with a lookback window of 120 days
    corr_with_returns = {
        'rsi': df['rsi'].rolling(window=120).corr(df['daily_return'].shift(-1)),
        'atr': df['atr'].rolling(window=120).corr(df['daily_return'].shift(-1)),
        'macd': df['macd'].rolling(window=120).corr(df['daily_return'].shift(-1)),
        'macd_signal': df['macd_signal'].rolling(window=120).corr(df['daily_return'].shift(-1)),
        'macd_diff': df['macd_diff'].rolling(window=120).corr(df['daily_return'].shift(-1))
    }
    
    # Generate heuristic matrix using rolling correlations
    heuristics_matrix = (df['rsi'] * corr_with_returns['rsi'] +
                         df['atr'] * corr_with_returns['atr'] +
                         df['macd'] * corr_with_returns['macd'] +
                         df['macd_signal'] * corr_with_returns['macd_signal'] +
                         df['macd_diff'] * corr_with_returns['macd_diff'])
    
    return heuristics_matrix
