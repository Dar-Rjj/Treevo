import pandas as pd
import numpy as np

def heuristics_v2(df):
    # Compute daily return
    df['daily_return'] = df['close'].pct_change()
    
    # Calculate RSI
    delta = df['close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=14).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=14).mean()
    rs = gain / loss
    df['rsi'] = 100 - (100 / (1 + rs))
    
    # Calculate DMI
    df['high_low'] = df['high'] - df['low']
    df['high_close_prev'] = abs(df['high'] - df['close'].shift(1))
    df['low_close_prev'] = abs(df['low'] - df['close'].shift(1))
    df['tr'] = df[['high_low', 'high_close_prev', 'low_close_prev']].max(axis=1)
    df['dm_pos'] = (df['high'] - df['high'].shift(1)).where(lambda x: x > 0, 0)
    df['dm_neg'] = (df['low'].shift(1) - df['low']).where(lambda x: x > 0, 0)
    df['di_pos'] = 100 * (df['dm_pos'].rolling(window=14).sum() / df['tr'].rolling(window=14).sum())
    df['di_neg'] = 100 * (df['dm_neg'].rolling(window=14).sum() / df['tr'].rolling(window=14).sum())
    df['dmi'] = df['di_pos'] - df['di_neg']
    
    # Calculate OBV
    df['obv'] = (np.sign(df['close'].diff()) * df['volume']).fillna(0).cumsum()
    
    # Historical R^2
    r_squared = {'rsi': np.corrcoef(df['rsi'], df['daily_return'].shift(-1))[0, 1] ** 2,
                 'dmi': np.corrcoef(df['dmi'], df['daily_return'].shift(-1))[0, 1] ** 2,
                 'obv': np.corrcoef(df['obv'], df['daily_return'].shift(-1))[0, 1] ** 2}
    
    # Generate heuristic matrix
    heuristics_matrix = (df['rsi'] * r_squared['rsi'] +
                         df['dmi'] * r_squared['dmi'] +
                         df['obv'] * r_squared['obv'])
    
    return heuristics_matrix
