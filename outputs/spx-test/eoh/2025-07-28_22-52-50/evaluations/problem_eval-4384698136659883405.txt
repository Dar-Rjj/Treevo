import pandas as pd

def heuristics_v2(df):
    # Calculate ATR
    df['H-L'] = df['high'] - df['low']
    df['H-PC'] = abs(df['high'] - df['close'].shift(1))
    df['L-PC'] = abs(df['low'] - df['close'].shift(1))
    df['TR'] = df[['H-L', 'H-PC', 'L-PC']].max(axis=1)
    atr_period = 20
    df['ATR'] = df['TR'].rolling(window=atr_period).mean()

    # Calculate MFI
    mfi_period = 20
    typical_price = (df['high'] + df['low'] + df['close']) / 3
    raw_money_flow = typical_price * df['volume']
    positive_flow = raw_money_flow.where(typical_price > typical_price.shift(1), 0)
    negative_flow = raw_money_flow.where(typical_price < typical_price.shift(1), 0)
    positive_mf = positive_flow.rolling(window=mfi_period).sum()
    negative_mf = negative_flow.rolling(window=mfi_period).sum()
    money_flow_ratio = positive_mf / negative_mf
    df['MFI'] = 100 - (100 / (1 + money_flow_ratio))

    # Calculate RSI
    delta = df['close'].diff()
    up, down = delta.copy(), delta.copy()
    up[up < 0] = 0
    down[down > 0] = 0
    rsi_period = 20
    gain = up.ewm(com=rsi_period-1, adjust=False).mean()
    loss = down.abs().ewm(com=rsi_period-1, adjust=False).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))

    # Calculate EMA crossovers
    short_ema_period = 20
    long_ema_period = 100
    df['EMA_Short'] = df['close'].ewm(span=short_ema_period, adjust=False).mean()
    df['EMA_Long'] = df['close'].ewm(span=long_ema_period, adjust=False).mean()
    ema_crossover = df['EMA_Short'] - df['EMA_Long']

    # Combined heuristic: ATR adjusted by MFI and RSI, plus EMA crossover
    heuristics_matrix = df['ATR'] + (df['MFI'] - 50) * 0.02 * df['ATR'] + (df['RSI'] - 50) * 0.02 * df['ATR'] + ema_crossover

    return heuristics_matrix
