import pandas as pd

def heuristics_v2(df):
    # Calculate ATR
    df['H-L'] = df['high'] - df['low']
    df['H-PC'] = abs(df['high'] - df['close'].shift(1))
    df['L-PC'] = abs(df['low'] - df['close'].shift(1))
    df['TR'] = df[['H-L', 'H-PC', 'L-PC']].max(axis=1)
    atr_period = 14
    df['ATR'] = df['TR'].rolling(window=atr_period).mean()

    # Calculate MFI
    mfi_period = 14
    typical_price = (df['high'] + df['low'] + df['close']) / 3
    raw_money_flow = typical_price * df['volume']
    positive_flow = raw_money_flow.where(typical_price > typical_price.shift(1), 0)
    negative_flow = raw_money_flow.where(typical_price < typical_price.shift(1), 0)
    positive_mf = positive_flow.rolling(window=mfi_period).sum()
    negative_mf = negative_flow.rolling(window=mfi_period).sum()
    money_flow_ratio = positive_mf / negative_mf
    df['MFI'] = 100 - (100 / (1 + money_flow_ratio))

    # Calculate EMA crossovers
    short_ema_period = 12
    long_ema_period = 26
    df['EMA_Short'] = df['close'].ewm(span=short_ema_period, adjust=False).mean()
    df['EMA_Long'] = df['close'].ewm(span=long_ema_period, adjust=False).mean()
    ema_crossover = df['EMA_Short'] - df['EMA_Long']

    # Calculate RSI
    rsi_period = 14
    delta = df['close'].diff()
    gain = (delta.where(delta > 0, 0)).rolling(window=rsi_period).mean()
    loss = (-delta.where(delta < 0, 0)).rolling(window=rsi_period).mean()
    rs = gain / loss
    df['RSI'] = 100 - (100 / (1 + rs))

    # Calculate WMA
    wma_period = 14
    weights = pd.Series(range(1, wma_period + 1))
    df['WMA'] = df['close'].rolling(window=wma_period).apply(lambda prices: (prices * weights).sum() / weights.sum(), raw=True)

    # Combined heuristic: ATR adjusted by MFI, EMA crossover, RSI, and WMA
    heuristics_matrix = df['ATR'] + (df['MFI'] - 50) * 0.01 * df['ATR'] + ema_crossover + df['RSI'] * 0.01 * df['ATR'] + df['WMA'] - df['close']

    return heuristics_matrix
