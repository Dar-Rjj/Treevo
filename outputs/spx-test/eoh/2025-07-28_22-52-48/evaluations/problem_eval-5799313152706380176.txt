import pandas as pd

def heuristics_v2(df):
    def compute_macd(price_series, n_fast=12, n_slow=26):
        ema_fast = price_series.ewm(span=n_fast, min_periods=n_fast).mean()
        ema_slow = price_series.ewm(span=n_slow, min_periods=n_slow).mean()
        macd = ema_fast - ema_slow
        return macd

    def compute_rsi(price_series, periods=14):
        delta = price_series.diff(1)
        gain = (delta.where(delta > 0, 0)).fillna(0)
        loss = (-delta.where(delta < 0, 0)).fillna(0)
        avg_gain = gain.rolling(window=periods, min_periods=periods).mean()
        avg_loss = loss.rolling(window=periods, min_periods=periods).mean()
        rs = avg_gain / avg_loss
        rsi = 100 - (100 / (1 + rs))
        return rsi

    def compute_stochastic_oscillator(high, low, close, k_period=14, d_period=3):
        l14 = low.rolling(window=k_period, min_periods=k_period).min()
        h14 = high.rolling(window=k_period, min_periods=k_period).max()
        k_percent = 100 * ((close - l14) / (h14 - l14))
        d_percent = k_percent.rolling(window=d_period, min_periods=d_period).mean()
        return d_percent

    def compute_weighted_average(values, weights):
        return (values * weights).sum(axis=1)

    close_prices = df['close']
    high_prices = df['high']
    low_prices = df['low']

    macd_values = compute_macd(close_prices)
    rsi_values = compute_rsi(close_prices)
    stoch_osc_values = compute_stochastic_oscillator(high_prices, low_prices, close_prices)

    # Compute the recent predictive power (weights) for each indicator
    macd_returns_corr = macd_values.rolling(window=20).corr(close_prices.pct_change().shift(-1))
    rsi_returns_corr = rsi_values.rolling(window=20).corr(close_prices.pct_change().shift(-1))
    stoch_osc_returns_corr = stoch_osc_values.rolling(window=20).corr(close_prices.pct_change().shift(-1))

    # Normalize the weights
    weights = pd.DataFrame({
        'macd': macd_returns_corr,
        'rsi': rsi_returns_corr,
        'stoch_osc': stoch_osc_returns_corr
    })
    weights = weights.div(weights.sum(axis=1), axis=0)

    # Heuristic matrix: weighted combination of MACD, RSI, and Stochastic Oscillator
    heuristics_matrix = compute_weighted_average(pd.DataFrame({
        'macd': macd_values,
        'rsi': rsi_values,
        'stoch_osc': stoch_osc_values
    }), weights)

    return heuristics_matrix
