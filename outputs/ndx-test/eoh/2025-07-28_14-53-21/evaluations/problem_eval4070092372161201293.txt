def heuristics_v2(df):
    # Calculate the Exponential Moving Average (EMA) of returns
    returns = df['close'].pct_change()
    ema_returns = returns.ewm(span=20, adjust=False).mean()
    
    # Calculate the Average True Range (ATR)
    tr = df[['high', 'low', 'close']].diff().abs().max(axis=1)
    atr = tr.rolling(window=14).mean()
    
    # Dynamic weight allocation based on the ratio of ATR to EMA
    weight_ema = (atr / (atr + ema_returns)).fillna(0.5)
    weight_atr = 1 - weight_ema
    
    # Combine EMA of returns and ATR into a single heuristic factor
    heuristics_matrix = weight_ema * ema_returns + weight_atr * atr
    
    return heuristics_matrix
