def heuristics_v2(df):
    # Calculate the rate of change (ROC) over a 20-day period
    roc = df['close'].pct_change(periods=20)
    
    # Calculate the average true range (ATR) over a 21-day period
    tr = df[['high', 'low']].diff().abs().max(axis=1)
    atr = tr.rolling(window=21).mean()
    
    # Combine the ROC and ATR
    combined_metric = (roc - atr)
    
    # Weight the combined metric by the 5-day moving average of volume
    volume_weighted = combined_metric * df['volume'].rolling(window=5).mean()
    
    # Rank the final weighted metric
    heuristics_matrix = volume_weighted.rank(pct=True)
    
    return heuristics_matrix
